@if (isLoading) {
<div class="loading-container">
    <p>Loading product details...</p>
</div>
} @else if (error) {
<div class="error-container">
    <p>{{ error }}</p>
</div>
} @else if (product) {
<div class="product-detail-container">
    <div class="product-card">
        <div class="product-header">
            @if (brand) {
            <img [src]="'assets/' + brand.name.toUpperCase() + '.png'" [alt]="brand.name" class="brand-logo"> }
            <h1>{{ product.name }}</h1>
        </div>
        <div class="product-content">
            <div class="product-image">
                <img [src]="product.photo_url" [alt]="product.name">
            </div>
            <div class="product-info">
                <div class="price">
                    @if (product.discounts && product.discounts.length > 0) {
                    <div class="price-line">
                        <span class="discount-price">{{ (product.price - product.discounts[0].value).toFixed(2) | currency:'EUR' }}</span>
                        <span class="price-unit">/ {{ product.price_unit.replace('_', ' ') }}</span>
                    </div>
                    <span class="original-price">{{ product.price | currency:'EUR' }}</span> } @else {
                    <div class="price-line">
                        <span>{{ product.price | currency:'EUR' }}</span>
                        <span class="price-unit">/ {{ product.price_unit.replace('_', ' ') }}</span>
                    </div>
                    }
                </div>

                @if (product.weight) {
                <p><strong>Weight:</strong> {{ product.weight }}g</p>
                } @if (product.description) {
                <p><strong>Description:</strong> {{ product.description }}</p>
                } @if (product.discounts && product.discounts.length > 0) {
                <button class="view-discounts-btn" (click)="isModalOpen = true">View All Discounts</button> }

                <button class="wishlist-btn" [class.wishlisted]="isWishlisted" (click)="toggleWishlist()" aria-label="Wishlist toggle">
                    <i [ngClass]="isWishlisted ? 'fas fa-heart-broken' : 'far fa-heart'"></i>
                    <span>{{ isWishlisted ? 'Remove from wishlist' : 'Add to wishlist' }}</span>
                </button> @if (isUserRole) {
                <button class="report-btn" (click)="openReportModal()" [disabled]="hasReported" aria-label="Report product">
                    <i class="fas fa-flag"></i>
                    <span>{{ hasReported ? 'Reported' : 'Report a problem' }}</span>
                </button> }
            </div>
        </div>
    </div>

    @if (discountHistory.length > 0) {
    <div class="discount-history">
        <h2>Discount History</h2>
        <table>
            <thead>
                <tr>
                    <th>Discount Name</th>
                    <th>Value</th>
                    <th>Started At</th>
                    <th>Ended At</th>
                </tr>
            </thead>
            <tbody>
                @for (record of discountHistory; track record.id) {
                <tr>
                    <td>{{ record.discount.name }}</td>
                    <td>{{ record.discount.value }}{{ record.discount.discount_type === 'percentage' ? '%' : 'â‚¬' }}</td>
                    <td>{{ record.discount.starts_at | date:'short' }}</td>
                    <td>{{ record.discount.ends_at | date:'short' }}</td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    } @if (isModalOpen) {
    <div class="modal-backdrop" (click)="isModalOpen = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <button class="modal-close-btn" (click)="isModalOpen = false">&times;</button>
            <h2>All Available Discounts</h2>
            <ul>
                @for (discount of product.discounts; track discount.id) {
                <li>{{ discount.name }}</li>
                }
            </ul>
        </div>
    </div>
    } @if (isReportModalOpen) {
    <div class="modal-backdrop" (click)="closeReportModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <button class="modal-close-btn" (click)="closeReportModal()">&times;</button>
            <h2>Report a problem</h2>
            <div class="report-form">
                <label for="reason"><strong>Reason</strong></label>
                <div class="select-wrapper">
                    <select id="reason" class="report-select" [(ngModel)]="reportReason">
                        <option value="" disabled>Select reason</option>
                        <option value="name">Incorrect name</option>
                        <option value="photo">Incorrect photo</option>
                        <option value="price">Incorrect price</option>
                    </select>
                    <i class="fas fa-chevron-down"></i>
                </div>

                <label for="description"><strong>Description</strong></label>
                <textarea id="description" rows="4" [(ngModel)]="reportDescription" placeholder="Describe the issue..."></textarea>

                <div class="actions">
                    <button class="wishlist-btn" (click)="submitReport()">
                        <i class="fas fa-paper-plane"></i>
                        <span>Submit report</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    } @if (relatedProducts.length > 0) {
    <div class="related-products">
        <h2>Related Products</h2>
        <div class="products-grid">
            @for (relatedProduct of relatedProducts; track relatedProduct.id) {
            <div class="product-item" (click)="navigateToProduct(relatedProduct.id)">
                <img [src]="relatedProduct.photo_url" [alt]="relatedProduct.name">
                <h3>{{ relatedProduct.name }}</h3>
                @if (relatedProduct.discounts && relatedProduct.discounts.length > 0 && relatedProduct.discounts[0].effective_status === 'IN_ACTION') {
                <p class="discount-price">{{ (relatedProduct.price - relatedProduct.discounts[0].value).toFixed(2) | currency:'EUR' }}</p>
                <p class="original-price"><s>{{ relatedProduct.price | currency:'EUR' }}</s></p>
                } @else {
                <p>{{ relatedProduct.price | currency:'EUR' }}</p>
                }
            </div>
            }
        </div>
    </div>
    }
</div>
} @else {
<div class="error-container">
    <p>Product not found.</p>
</div>
}